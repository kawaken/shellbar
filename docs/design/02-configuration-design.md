# 設定ファイル設計

## 設定構造の方針

### 基本構造
- **フォーマット**: TOML形式
- **階層**: フラットな構造を基本とし、必要に応じてセクションを使用
- **時間の扱い**: 文字列で受け取り、内部でtime.Durationに変換

### 設定項目
- **format**: ステータスバーの表示フォーマット（変数展開対応）
- **refresh_rate**: 画面更新の最小間隔
- **defaults**: 各コマンドのデフォルト値（timeout、interval）
- **commands**: 実行するコマンドの定義

### ビルトインコマンドと設定なし動作
- **ビルトインコマンド**: アプリケーションに組み込まれた基本的なコマンド群
- **設定なし動作**: 設定ファイルがなくても、ビルトインコマンドとデフォルトフォーマットで動作
- **ビルトインコマンドの選定基準**: 
  - 環境に依存しない（どの環境でも確実に動作）
  - 意味のある情報を提供
  - 例：`path`（pwd）、`datetime`（date）

### 設定の適用ルール
- **設定ファイルなし**: ビルトインコマンド + デフォルトフォーマット
- **設定ファイルあり**: ビルトインコマンド + ユーザー定義コマンド + ユーザーフォーマット
- **個別設定が最優先**: commandsで個別に設定された値を使用
- **defaults次優先**: 個別設定がない場合はdefaultsセクションの値を使用
- **ハードコードが最後**: defaultsも未定義の場合はコード内のハードコード値を使用

### デフォルト値
- **format**: `"{path} {git_branch} | {date} {time}"`
- **refresh_rate**: `"1s"` - 画面更新の最小間隔
- **defaults.interval**: `"5s"` - コマンド実行間隔のデフォルト
- **defaults.timeout**: `"3s"` - コマンドタイムアウトのデフォルト

## バリデーションポリシー

### 設定読み込み時にチェックする項目

1. **時間形式の妥当性**
   - 対象: refresh_rate、defaults.timeout、defaults.interval、各command.interval、各command.timeout
   - 理由: 早期エラー発見、設定ミスの防止
   - 手法: time.ParseDurationでの検証

2. **フォーマット文字列の整合性**
   - 対象: formatで参照している変数名（{variable_name}形式）
   - 理由: 実行時に空文字になるのを防ぐ
   - 例: `{git_branch}`を使うなら`commands.git_branch`が必要

3. **必須フィールドの存在**
   - 対象: 各commandのcommandフィールド
   - 理由: 実行すべきコマンドが未定義だと意味がない

### 実行時にチェックする項目

1. **コマンドの実行可能性**
   - 理由: 環境依存のため設定時では判断できない
   - 対処: エラーをキャッシュして継続実行

## エラーハンドリング戦略

### 設定読み込みエラー
- **ファイル不存在**: デフォルト設定で動作開始
- **TOML解析エラー**: エラーメッセージ表示後、デフォルト設定で継続
- **バリデーションエラー**: 具体的なエラーメッセージで停止

### バリデーションエラーの種類
- **時間形式エラー**: 正しいフォーマット例を提示
- **フォーマット整合性エラー**: 未定義の変数名を具体的に指摘
- **必須フィールドエラー**: どのコマンドのcommandが未定義かを明示

### 実行時エラー
- **コマンド失敗**: エラー内容をキャッシュして表示継続
- **タイムアウト**: 前回の結果を使用、エラー状態も表示

## 設定ファイル検索の優先順位

1. `~/.config/shellbar/shellbar.toml` （XDG準拠）
2. `~/.shellbar.toml` （ホームディレクトリ直下）
3. デフォルト設定での動作

## 設計判断の根拠

### TOML選択の理由
- JSONより人間が読みやすい
- YAMLより構造がシンプル
- コメントが書ける
- 複数行文字列が書きやすい（複雑なシェルコマンドに対応）

### 時間を文字列で扱う理由
- 設定ファイルでの可読性（「1s」「500ms」など直感的）
- Go標準のtime.ParseDurationとの親和性
- 型安全性は実装側で保証

### フォーマット文字列検証の理由
- 設定ミスの早期発見
- ユーザーフレンドリーなエラーメッセージ

### デフォルト設定の最小化
- 設定なしでも動作する
- 環境依存性を最小限に抑える
- ユーザーの学習コストを下げる
- 段階的な設定追加が可能
